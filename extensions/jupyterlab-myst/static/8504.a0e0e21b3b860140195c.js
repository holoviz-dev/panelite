"use strict";(self.webpackChunkjupyterlab_myst=self.webpackChunkjupyterlab_myst||[]).push([[8504],{88504:(e,t,r)=>{r.r(t),r.d(t,{default:()=>ae});var n=r(56592),s=r(70552),o=r(9712),i=r(16e3),a=r(24912),d=r(73592);const l="user_expressions";function c(e){var t;return e.model.getMetadata?e.model.getMetadata(l):null===(t=e.model.metadata)||void 0===t?void 0:t.get(l)}var u=r(72292),m=r(90876),h=r(49332),p=r(43884),f=r(35604),g=r(76512),v=r.n(g);const y=(0,g.createContext)(void 0);function x({controller:e,children:t}){return v().createElement(y.Provider,{value:{controller:e}},t)}const b=(0,g.createContext)(void 0);function k({sanitizer:e,children:t}){return v().createElement(b.Provider,{value:{sanitizer:e}},t)}const w=(0,g.createContext)(void 0);function E({expressions:e,rendermime:t,trusted:r,children:n}){return v().createElement(w.Provider,{value:{expressions:e,rendermime:t,trusted:r}},n)}var _=r(50376),M=r(43760);class C extends M.Widget{constructor(){super(),this.addClass("myst-RenderedExpressionError")}}class T extends M.Widget{constructor(e){super(),this.trusted=e.trusted,this.expression=e.expression,this.rendermime=e.rendermime,this.safe=e.safe,this.addClass("myst-RenderedExpression"),(this.layout=new M.SingletonLayout).widget=new C}renderExpression(e){const t=this.layout;if(!t)return console.error("Our layout is already disposed!!"),Promise.resolve();if(this.isDisposed)return console.error("Our layout is already disposed!!"),Promise.resolve();let r;r="ok"===e.status?{trusted:this.trusted,data:e.data,metadata:e.metadata}:{data:{"application/vnd.jupyter.stderr":e.traceback.join("\n")||`${e.ename}: ${e.evalue}`}};const n=this.rendermime.createModel(r),s=this.rendermime.preferredMimeType(n.data,this.safe);if(void 0===s)return console.error("Couldn't find mimetype for ",n),t.widget=new C,Promise.resolve();const o=this.rendermime.createRenderer(s);return t.widget=o,console.assert(o.isAttached,"renderer was not attached!",o),o.renderModel(n)}}function R({content:e}){return e=e.replace(/^(["'])(.*)\1$/,"$2"),v().createElement("span",null,e)}function S({error:e}){return v().createElement("span",{className:"text-black p-2","data-mime-type":"application/vnd.jupyter.stderr",style:{backgroundColor:"var(--jp-rendermime-error-background, #F9DEDE)",fontFamily:"var(--jp-code-font-family, monospace)",fontSize:"var(--jp-code-font-size)"}},v().createElement("span",{className:"text-[#e75c58]"},e.ename),": ",e.evalue)}function P({rendermime:e,trusted:t,expressionMetadata:r}){const n=(0,g.useRef)(null),[s,o]=(0,g.useState)(void 0);return(0,g.useEffect)((()=>{console.debug(`Creating inline renderer for  \`${r.expression}\``);const n=new T({expression:r.expression,trusted:t,rendermime:e,safe:"any"});return o(n),()=>{n.isAttached&&!n.node.isConnected?console.error(`Could not dispose of renderer for \`${r.expression}\`: node is not connected`):n.dispose()}}),[e,r]),(0,g.useEffect)((()=>{const e=s;if(n.current&&e)return e.isAttached&&console.error(`Expression renderer for \`${r.expression}\` is already attached to another node`),M.Widget.attach(e,n.current),console.debug(`Attached expression renderer for \`${r.expression}\` to parent widget`),()=>{e.isAttached&&!e.node.isConnected?console.error(`Unable to detach expression renderer for \`${r.expression}\`: node is not connected`):e.isAttached&&(console.debug(`Detaching expression renderer for \`${r.expression}\``),M.Widget.detach(e))};console.debug(`Cannot attach expression renderer for \`${r.expression}\``)}),[n,s]),(0,g.useEffect)((()=>{s&&r?s.renderExpression(r.result):console.debug(`Cannot render expression \`${r.expression}\``)}),[s,r]),console.debug(`Rendering MIME bundle for expression: '${r.expression}'`),v().createElement("div",{ref:n,className:"not-prose inline-block"})}function D({value:e}){const{expressions:t,rendermime:r,trusted:n}=null!==(s=(0,g.useContext)(w))&&void 0!==s?s:{};var s;if(!t||!r)return v().createElement("code",null,e);const o=null==t?void 0:t.find((t=>t.expression===e)),i=null==o?void 0:o.result.data;return console.debug(`Rendering \`${e}\` inline ${n?"with":"without"} trust`),o?(console.debug(`Using MIME bundle for \`${e}\``,i),"text/plain"===r.preferredMimeType(null!=i?i:{},n?"any":"ensure")?v().createElement(R,{content:null==i?void 0:i["text/plain"]}):"error"===o.result.status?(console.debug("Error for",e,o.result),v().createElement(S,{error:o.result})):v().createElement(P,{rendermime:r,trusted:!!n,expressionMetadata:o})):(console.debug("No metadata for",e),v().createElement("code",null,e))}function I({checked:e,line:t,children:r}){const[n,s]=v().useState(null!=e&&e),{controller:o}=null!==(i=(0,g.useContext)(y))&&void 0!==i?i:{};var i;return v().createElement("li",{className:"task-list-item"},v().createElement("input",{type:"checkbox",disabled:!o,className:"task-list-item-checkbox",checked:n,onClick:()=>{o&&void 0!==t&&(o({line:t-1,checked:!n}),s(!n))}}),r)}function A({checked:e,line:t,children:r}){return"boolean"==typeof e?v().createElement(I,{checked:e,line:t},v().createElement(f.MyST,{ast:r})):v().createElement("li",null,v().createElement(f.MyST,{ast:r}))}const F={...f.DEFAULT_RENDERERS,mermaid:_.MermaidNodeRenderer,inlineExpression:({node:e})=>v().createElement(D,{value:e.value}),listItem:({node:e})=>{var t;return v().createElement(A,{checked:e.checked,line:null===(t=e.position)||void 0===t?void 0:t.start.line,children:e.children})},html:({node:e},t)=>{const{sanitizer:r}=null!==(n=(0,g.useContext)(b))&&void 0!==n?n:{};var n;return void 0!==r?v().createElement("span",{className:"jp-RenderedHTMLCommon not-prose",dangerouslySetInnerHTML:{__html:r.sanitize(e.value)}}):v().createElement("pre",null,e.value)}};var j=r(58346),$=r(94852);async function N(e,t){const r=(0,j.CO)("link,linkBlock",e);await Promise.all(r.map((async e=>{if(!e||!e.url)return;const r=t.resolver,n=e.url;if((0,$.updateLinkTextIfEmpty)(e,n),((null==r?void 0:r.isLocal)?r.isLocal(n):a.URLExt.isLocal(n))&&r)if(e.static){const t=await r.resolveUrl(n),s=await r.getDownloadUrl(t);e.urlSource=n,e.url=s}else e.internal=!0})))}class L extends h.VDomModel{get references(){return this._references}set references(e){this._references=e,this.stateChanged.emit()}get mdast(){return this._mdast}set mdast(e){this._mdast=e,this.stateChanged.emit()}get expressions(){return this._expressions}set expressions(e){this._expressions=e,this.stateChanged.emit()}get frontmatter(){return this._frontmatter}set frontmatter(e){this._frontmatter=e,this.stateChanged.emit()}}class z extends h.VDomRenderer{constructor(e){const{model:t,resolver:r,linkHandler:n,rendermime:s,trusted:o,sanitizer:i}=e;super(t),this._trusted=!1,this._taskItemChanged=new u.Signal(this),this._resolver=r,this._linkHandler=n,this._rendermime=s,this._trusted=o,this._sanitizer=i,this._taskItemController=e=>this._taskItemChanged.emit(e),this.addClass("myst")}get taskItemChanged(){return this._taskItemChanged}get trusted(){return this._trusted}set trusted(e){this._trusted=e,this.update()}render(){if(console.debug("Re-rendering VDOM for MySTWidget",this.model,this._trusted),!this.model)return v().createElement("span",null,"MyST Renderer!");const{references:e,frontmatter:t,mdast:r,expressions:n}=this.model;return v().createElement(x,{controller:this._taskItemController},v().createElement(p.ThemeProvider,{theme:"undefined"==typeof document?p.Theme.light:"false"===document.body.dataset.jpThemeLight?p.Theme.dark:p.Theme.light,Link:(s=this._resolver,o=this._linkHandler,e=>{const t=v().useRef(null),{to:r}=e;return v().useEffect((()=>{t&&t.current&&s&&async function(e,t,r){let n=e.getAttribute("href")||"";const s=t.isLocal?t.isLocal(n):a.URLExt.isLocal(n);if(!n||!s)return;const o=e.hash;if(o){if(o===n)return void(e.target="_self");n=n.replace(o,"")}try{const s=await t.resolveUrl(n),i=decodeURIComponent(s);r&&r.handleLink(e,i,o);const a=await t.getDownloadUrl(s);e.href=a+o}catch(t){e.href=""}}(t.current,s,o)}),[t,r]),v().createElement("a",{href:r,ref:t,className:e.className},e.children)}),renderers:F},v().createElement(k,{sanitizer:this._sanitizer},v().createElement(E,{expressions:n,rendermime:this._rendermime,trusted:this._trusted},v().createElement(p.TabStateProvider,null,v().createElement(p.ReferencesProvider,{references:e,frontmatter:t},t&&v().createElement(m.FrontmatterBlock,{frontmatter:t}),v().createElement(f.MyST,{ast:r})))))));var s,o}}var H=r(72224),U=r(58864),W=r(46838),O=r(65260),q=r(45940),J=r(8328),V=r(69164),B=r(64480),G=r(90352),K=r(2284);const Q=()=>e=>{!async function(e){(0,j.CO)("cite",e).forEach((async e=>{e.children&&e.children.length>0||(e.error=!0,e.children=[{type:"text",value:e.label}])}))}(e)};async function X(e,t){const r=t.resolver;if(!r)return;const n=(0,j.CO)("image",e);await Promise.all(n.map((async e=>{if(!e||!e.url)return;const t=await r.resolveUrl(e.url);if(!t)return;const n=await r.getDownloadUrl(t);n&&(e.url=n)})))}function Y(e){const t=e=>(0,H.mystParse)(e,{markdownit:{linkify:!0},directives:[J.cardDirective,...V.gridDirectives,G.proofDirective,...K.exerciseDirectives,...B.tabDirectives],roles:[]}),r=t(e);return(0,W.C)().use($.basicTransformationsPlugin,{parser:t}).runSync(r),r}function Z(e){return"markdown"===e.model.type}class ee extends i.MarkdownCell{constructor(e){var t,r,n;super(e),this._metadataJustChanged=!1,this._notebookRendermime=e.rendermime,this._attachmentsResolver=new d.AttachmentsResolver({parent:null!==(t=e.rendermime.resolver)&&void 0!==t?t:void 0,model:this.model.attachments}),this._mystModel=new L,this._mystWidget=new z({model:this._mystModel,rendermime:this._notebookRendermime,linkHandler:null!==(r=this._notebookRendermime.linkHandler)&&void 0!==r?r:void 0,resolver:this._attachmentsResolver,trusted:this.model.trusted,sanitizer:null!==(n=this._notebookRendermime.sanitizer)&&void 0!==n?n:void 0}),this._mystWidget.taskItemChanged.connect(((e,t)=>this.setTaskItem(e,t))),this._renderer.dispose(),this._renderer=this._notebookRendermime.createRenderer("text/plain"),this.model.onTrustedChanged=()=>this.onModelTrustedChanged(),this._monitor.dispose(),this._monitor=this.createActivityMonitor(),this._handleRendered=this.onRenderedChanged,this.restoreExpressionsFromMetadata()}setTaskItem(e,t){const r=this.model.sharedModel.getSource().split("\n");r[t.line]=r[t.line].replace(/^(\s*(?:-|\*)\s*)(\[[\s|x]\])/,t.checked?"$1[x]":"$1[ ]"),this.model.sharedModel.setSource(r.join("\n"))}async onRenderedChanged(){if(this.rendered){if(this.placeholder)return void await this.updateFragmentMDAST();this.rendered&&await this.render()}else this.showEditor()}createActivityMonitor(){const e=new a.ActivityMonitor({signal:this.model.contentChanged,timeout:100});return this.ready.then((()=>{this.isDisposed||(console.debug("ready and connected activityStopped signal"),e.activityStopped.connect((()=>{console.debug("Activity monitor expired"),this.rendered&&!this._metadataJustChanged&&(console.debug("Updating cell!"),this.update()),this._metadataJustChanged=!1}),this))})).catch((e=>{console.error("Failed to be ready",e)})),e}restoreExpressionsFromMetadata(){const e=c(this);void 0!==e&&(console.debug("Restoring expressions from metadata",e),this._mystWidget.model.expressions=e)}onModelTrustedChanged(){console.debug("trust changed",this.model.trusted),this._mystWidget.trusted=this.model.trusted,this.restoreExpressionsFromMetadata()}onMetadataChanged(e,t){console.debug("metadata changed",t),this._metadataJustChanged=!0,t.key===l?(console.debug("metadata changed",t),this.restoreExpressionsFromMetadata()):super.onMetadataChanged(e,t)}get attachmentsResolver(){return this._attachmentsResolver}get mystModel(){return this._mystModel}set mystModel(e){e!==this._mystModel&&this._mystModel.dispose(),this._mystModel=e,this._mystWidget.model=e}get fragmentMDAST(){return this._fragmentMDAST}async updateFragmentMDAST(){let e=Y(this.model.sharedModel.getSource());this._attachmentsResolver&&(e=await async function(e,t){t=(0,U.copyNode)(t);try{await X(t,{resolver:e})}catch(e){}return t}(this._attachmentsResolver,e)),e.type="block",this._fragmentMDAST=e}async render(){await this.updateFragmentMDAST(),this._mystWidget.node&&this.isAttached&&(await async function(e){var t;const r=e.widgets.filter(Z).filter((e=>void 0!==e.fragmentMDAST)),n=function(e){return{type:"root",children:e.map((e=>(0,U.copyNode)(e.fragmentMDAST)))}}(r),{references:s,frontmatter:o,mdast:i}=await async function(e,t){var r;const n=[new $.WikiTransformer,new $.GithubTransformer,new $.DOITransformer,new $.RRIDTransformer],s=new O.I,o={cite:{order:[],data:{}},article:e},{frontmatter:i}=(0,$.getFrontmatter)(s,e.children[0]),a=(0,q.validatePageFrontmatter)(i,{property:"frontmatter",messages:{}}),d=new $.ReferenceState("<PATH>",{numbering:a.numbering,vfile:s});return(0,W.C)().use($.mathPlugin,{macros:null!==(r=null==a?void 0:a.math)&&void 0!==r?r:{}}).use($.glossaryPlugin).use($.abbreviationPlugin,{abbreviations:a.abbreviations}).use($.enumerateTargetsPlugin,{state:d}).use($.linksPlugin,{transformers:n}).use($.footnotesPlugin).use($.resolveReferencesPlugin,{state:d}).use(Q).use($.keysPlugin).runSync(e,s),await N(e,{resolver:t}),(0,$.reconstructHtmlTransform)(e),s.messages.length>0&&console.error(s.messages.map((e=>e.message)).join("\n")),{references:o,frontmatter:a,mdast:e}}(n,null!==(t=e.rendermime.resolver)&&void 0!==t?t:void 0);r.forEach(((e,t)=>{if(e.rendered){const r=new L;r.references=s,r.frontmatter=0===t?o:void 0,r.mdast=i.children[t],r.expressions=e.mystModel.expressions,e.mystModel=r}}))}(this.parent),await this._mystWidget.renderPromise,this.inputArea.renderInput(this._mystWidget))}}class te extends o.NotebookPanel.ContentFactory{createMarkdownCell(e){return e.contentFactory||(e.contentFactory=this),new ee(e).initializeState()}}var re=r(14720),ne=r(61992);const se="text/markdown";class oe extends z{constructor(e){var t,r,n,s;super({model:void 0,resolver:null!==(t=e.resolver)&&void 0!==t?t:void 0,linkHandler:null!==(r=e.linkHandler)&&void 0!==r?r:void 0,sanitizer:null!==(n=e.sanitizer)&&void 0!==n?n:void 0}),this.resolver=null!==(s=e.resolver)&&void 0!==s?s:void 0,this.node.dataset.mimeType=se,this.addClass("jp-RenderedMySTMarkdown")}async renderModel(e){if(window.trigger)throw Error("triggered!");const t=Y(e.data[se]),{references:r,mdast:n,frontmatter:s}=await async function(e,t){var r;e=(0,U.copyNode)(e);const n=[new $.WikiTransformer,new $.GithubTransformer,new $.DOITransformer,new $.RRIDTransformer],s=new O.I,o={cite:{order:[],data:{}},article:e},{frontmatter:i}=(0,$.getFrontmatter)(s,e),a=(0,q.validatePageFrontmatter)(i,{property:"frontmatter",messages:{}}),d=new $.ReferenceState("<PATH>",{numbering:a.numbering,vfile:s});return(0,W.C)().use($.mathPlugin,{macros:null!==(r=null==a?void 0:a.math)&&void 0!==r?r:{}}).use($.glossaryPlugin).use($.abbreviationPlugin,{abbreviations:a.abbreviations}).use($.enumerateTargetsPlugin,{state:d}).use($.linksPlugin,{transformers:n}).use($.footnotesPlugin).use($.resolveReferencesPlugin,{state:d}).use(Q).use($.keysPlugin).runSync(e,s),await N(e,{resolver:t}),await X(e,{resolver:t}),(0,$.reconstructHtmlTransform)(e),{references:o,frontmatter:a,mdast:e}}(t,this.resolver),o=new L;return o.references=r,o.mdast=n,o.frontmatter=s,this.model&&(o.expressions=this.model.expressions),this.model=o,console.debug("State changed",this),this.renderPromise||Promise.resolve()}}const ie={safe:!0,mimeTypes:["text/markdown"],defaultRank:50,createRenderer:e=>new oe(e)},ae=[{id:"jupyterlab-myst:content-factory",provides:o.NotebookPanel.IContentFactory,requires:[s.IEditorServices],autoStart:!0,activate:(e,t)=>{console.log("JupyterLab extension jupyterlab-myst is activated!");const r=t.factoryService.newInlineEditor;return new te({editorFactory:r})}},{id:"jupyterlab-myst:executor",requires:[o.INotebookTracker],autoStart:!0,activate:(e,t)=>{console.log("Using jupyterlab-myst:executor"),o.NotebookActions.executed.connect((async(e,r)=>{const{notebook:n,cell:s}=r;await async function(e,t,r){console.debug("Executing cell, expressions",c(t));const n=r.find((t=>t.content===e)),s=null==n?void 0:n.sessionContext;if(void 0===s)return;if(!function(e){return"markdown"===e.model.type}(t))return;console.debug(`Markdown cell ${t.model.id} was executed`),await t.updateFragmentMDAST();const o=await async function(e,t){var r,n,s;const o=null===(r=t.session)||void 0===r?void 0:r.kernel;if(!o)throw new Error("Session has no kernel.");const i=null!==(s=null===(n=e.mystModel)||void 0===n?void 0:n.mdast)&&void 0!==s?s:{},a=(0,j.CO)("inlineExpression",i).map((e=>e.value)),d=new Map(a.map(((e,t)=>[`${t}`,e])));if(console.debug("Executing named expressions",d),0===d.size)return Promise.resolve([]);const l={};d.forEach(((e,t)=>{l[t]=e}));const c={code:"",user_expressions:l};return new Promise(((e,t)=>{console.debug("Performing kernel request",c),o.requestExecute(c,!1).onReply=r=>{console.debug("Handling kernel response",r);const n=r.content;if("ok"!==n.status)return t("Kernel response was not OK");const s=[];for(const e in n.user_expressions){const r=d.get(e);if(void 0===r)return t("namedExpressions doesn't have key. This should never happen");const o={expression:r,result:n.user_expressions[e]};s.push(o)}return e(s)}}))}(t,s);console.debug("Handling evaluated user expressions",o),o.length?(console.debug("Setting metadata, before:",c(t),"after:",o),function(e,t){e&&(e.model.setMetadata?e.model.setMetadata(l,t):e.model.metadata.set(l,t))}(t,o)):function(e){e&&(e.model.setMetadata?e.model.deleteMetadata(l):e.model.metadata.delete(l))}(t),t.model.trusted=!0}(n,s,t)}))}},{id:"jupyterlab-myst:mime-renderer",requires:[re.IRenderMimeRegistry],autoStart:!0,optional:[n.IMarkdownViewerTracker,ne.ISettingRegistry],activate:(e,t,r,n)=>{console.log("Using jupyterlab-myst:mime-renderer"),n&&n.load("@jupyterlab/markdownviewer-extension:plugin").then((e=>{e.set("hideFrontMatter",!1)})),t.addFactory(ie)}}]}}]);